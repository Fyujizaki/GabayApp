<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- FIXED: Maximum scale and user-scalable=no ensures app-like feel on mobile -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gabay - AI Rehabilitation Guide</title>

    <!-- Google Fonts: Playfair Display (Serif) & Lato (Sans) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap"
        rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        barong: {
                            cream: '#F5F5DC',
                            beige: '#FDFCF0',
                            navy: '#0C1821',
                            gold: '#C5A028', // Darkened from #D4AF37 for better contrast
                            pink: '#E6B8B8',
                            blue: '#334155',
                            dark: '#0F172A',
                        }
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Lato"', 'sans-serif'],
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'gradient-xy': 'gradient-xy 15s ease infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        'gradient-xy': {
                            '0%, 100%': { 'background-size': '400% 400%', 'background-position': 'left center' },
                            '50%': { 'background-size': '200% 200%', 'background-position': 'right center' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .stitch-border {
            border: 1px dashed #C5A028;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin defer></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin defer></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
    <!-- Marked for Markdown Rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="" defer></script>

</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // --- API KEY ---
        // IMPORTANT: Replace with your actual Gemini API Key
        const apiKey = "AIzaSyAVJ5RK8y3yNiHDnRTkLThT0VJ7JUw_-b8";

        // --- ICONS ---
        const Icon = React.memo(({ d, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{d}</svg>
        ));

        const Icons = {
            MessageSquare: (p) => <Icon {...p} d={<><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></>} />,
            Briefcase: (p) => <Icon {...p} d={<><rect x="2" y="7" width="20" height="14" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></>} />,
            User: (p) => <Icon {...p} d={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>} />,
            Award: (p) => <Icon {...p} d={<><circle cx="12" cy="8" r="7" /><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" /></>} />,
            Menu: (p) => <Icon {...p} d={<><line x1="3" y1="12" x2="21" y2="12" /><line x1="3" y1="6" x2="21" y2="6" /><line x1="3" y1="18" x2="21" y2="18" /></>} />,
            X: (p) => <Icon {...p} d={<><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></>} />,
            Send: (p) => <Icon {...p} d={<><line x1="22" y1="2" x2="11" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></>} />,
            Heart: (p) => <Icon {...p} d={<><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" /></>} />,
            MapPin: (p) => <Icon {...p} d={<><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" /></>} />,
            ShieldCheck: (p) => <Icon {...p} d={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /><path d="m9 12 2 2 4-4" /></>} />,
            BookOpen: (p) => <Icon {...p} d={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></>} />,
            Sun: (p) => <Icon {...p} d={<><circle cx="12" cy="12" r="5" /><line x1="12" y1="1" x2="12" y2="3" /><line x1="12" y1="21" x2="12" y2="23" /><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /><line x1="1" y1="12" x2="3" y2="12" /><line x1="21" y1="12" x2="23" y2="12" /></>} />,
            Moon: (p) => <Icon {...p} d={<><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" /></>} />,
            LogOut: (p) => <Icon {...p} d={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></>} />,
            CheckCircle: (p) => <Icon {...p} d={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></>} />,
            Sparkles: (p) => <Icon {...p} d={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z" /></>} />,
            PenTool: (p) => <Icon {...p} d={<><path d="m12 19 7-7 3 3-7 7-3-3z" /><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z" /><path d="m2 2 7.586 7.586" /><circle cx="11" cy="11" r="2" /></>} />,
            Lightbulb: (p) => <Icon {...p} d={<><line x1="9" y1="18" x2="15" y2="18" /><line x1="10" y1="22" x2="14" y2="22" /><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 9.5 6 4.65 4.65 0 0 0 7.5 11.5" /><path d="M9 18h6" /><path d="M10 22h4" /></>} />,
            Gift: (p) => <Icon {...p} d={<><polyline points="20 12 20 22 4 22 4 12" /><rect x="2" y="7" width="20" height="5" /><line x1="12" y1="22" x2="12" y2="7" /><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z" /><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z" /></>} />,
            Map: (p) => <Icon {...p} d={<><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6" /><line x1="8" y1="2" x2="8" y2="18" /><line x1="16" y1="6" x2="16" y2="22" /></>} />,
            AlertTriangle: (p) => <Icon {...p} d={<><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></>} />,
            Phone: (p) => <Icon {...p} d={<><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" /></>} />,
        };

        const Card = React.memo(({ children, className = "" }) => (
            <div className={`glass-panel stitch-border p-6 rounded-2xl shadow-sm bg-white/50 dark:bg-slate-800/50 ${className}`}>
                {children}
            </div>
        ));

        const Button = React.memo(({ children, onClick, variant = "primary", className = "", disabled = false }) => {
            const baseStyle = "px-4 py-2 rounded-xl font-bold transition-all active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2";
            const variants = {
                primary: "bg-barong-navy text-barong-gold border border-barong-gold shadow-md hover:bg-barong-navy/90",
                secondary: "bg-barong-gold/20 text-barong-navy border border-barong-gold/30 dark:text-white",
                outline: "border border-barong-navy/20 text-barong-navy hover:bg-barong-navy/5 dark:text-white dark:border-white/20",
                danger: "bg-red-50 text-red-600 border border-red-200 hover:bg-red-100"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant] || variants.primary} ${className}`}>
                    {children}
                </button>
            );
        });

        const Toggle = React.memo(({ checked, onChange }) => (
            <button onClick={() => onChange(!checked)} className={`w-12 h-6 rounded-full p-1 transition-colors ${checked ? 'bg-barong-gold' : 'bg-slate-300 dark:bg-slate-600'}`}>
                <div className={`w-4 h-4 bg-white rounded-full shadow-md transform transition-transform ${checked ? 'translate-x-6' : 'translate-x-0'}`} />
            </button>
        ));

        // --- MARKDOWN COMPONENT ---
        const MarkdownBlock = React.memo(({ content, className = "" }) => {
            const html = React.useMemo(() => marked.parse(content || ""), [content]);
            return (
                <div 
                    className={`prose prose-sm dark:prose-invert max-w-none ${className}`} 
                    dangerouslySetInnerHTML={{ __html: html }} 
                />
            );
        });

        const JOB_LISTINGS = [
            { id: 1, title: "Vocational Welding Course", organization: "Metro Manila Skills Hub", location: "Quezon City", type: "Training", duration: "3 Months", badge: "Certification" },
            { id: 2, title: "Community Garden Assistant", organization: "Green City Project", location: "Marikina", type: "Part-time", duration: "Ongoing", badge: "Allowance Provided" },
            { id: 3, title: "Basic IT & Data Entry", organization: "Digital Tesda Program", location: "Taguig (Online Option)", type: "Education", duration: "6 Weeks", badge: "Job Placement" }
        ];

        // UPDATED: RESOURCES with expandable details
        const RESOURCES = [
            { 
                title: "DREAM Center", 
                desc: "Residential rehab & vocational training.", 
                type: "Partner",
                details: [
                    { label: "Landline", value: "(02) 8123-4567", link: "tel:0281234567" },
                    { label: "Mobile", value: "0917-123-4567", link: "tel:09171234567" }
                ]
            },
            { 
                title: "Katarungan Program", 
                desc: "Community-based support groups.", 
                type: "Community",
                details: [
                    { label: "Coordinator", value: "0918-987-6543", link: "tel:09189876543" },
                    { label: "Schedule", value: "Mon-Fri, 8AM-5PM", link: null }
                ]
            },
            { 
                title: "Metro Health Line", 
                desc: "24/7 Emergency mental health support.", 
                type: "Emergency", 
                details: [
                    { label: "Hotline 1", value: "1553", link: "tel:1553" },
                    { label: "Hotline 2", value: "0917-899-USAP", link: "tel:09178998727" }
                ]
            }
        ];

        // --- CUSTOM HOOKS ---
        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = React.useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.error(error);
                    return initialValue;
                }
            });

            const setValue = React.useCallback((value) => {
                setStoredValue((currValue) => {
                    try {
                        const valueToStore = value instanceof Function ? value(currValue) : value;
                        window.localStorage.setItem(key, JSON.stringify(valueToStore));
                        return valueToStore;
                    } catch (error) {
                        console.error(error);
                        return currValue;
                    }
                });
            }, [key]);

            return [storedValue, setValue];
        };

        // --- API FUNCTIONS ---
        async function generateGeminiContent(prompt, systemInstruction) {
            if (!apiKey) { await new Promise(r => setTimeout(r, 1000)); return "(Demo Mode) This is simulated text. Add API Key to enable real AI."; }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ role: 'user', parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemInstruction }] } })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Connection issue.";
            } catch (error) { return "Error connecting to AI."; }
        }

        // UPDATED: STRICT INSTRUCTION FOR NATURAL TAGLISH
        async function callChatAI(prompt, history, userProfile, streak) {
            if (!apiKey) { await new Promise(r => setTimeout(r, 1500)); return `(Demo Mode) Hello ${userProfile.name}, this is a simulated response.`; }

            // REVISED SYSTEM PROMPT WITH STREAK INJECTION
            const systemPrompt = `You are Gabay, a compassionate, professional psychologist and rehabilitation guide based in Metro Manila. 
                User Profile: ${userProfile.name}, ${userProfile.age} years old, ${userProfile.sex}.
                Current Recovery Streak: ${streak} days.

                Persona: Professional yet warm.
                Language: Speak naturally in Taglish (mix of English and Tagalog) as a local Filipino would.
                CRITICAL: Do NOT provide translations in parentheses. Do NOT use asterisks or special formatting for Tagalog words. Just speak seamlessly in a natural conversational flow.
                Keep responses chat-friendly (max 3-4 sentences).`;

            const contents = [...history.map(msg => ({ role: msg.sender === 'user' ? 'user' : 'model', parts: [{ text: msg.text }] })), { role: 'user', parts: [{ text: prompt }] }];
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents, systemInstruction: { parts: [{ text: systemPrompt }] } })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Connection error.";
            } catch (e) { return "I apologize, I'm having trouble connecting."; }
        }

        const Toast = ({ message, type, onClose }) => {
            React.useEffect(() => {
                if (message) {
                    const timer = setTimeout(onClose, 3000);
                    return () => clearTimeout(timer);
                }
            }, [message, onClose]);

            if (!message) return null;

            return (
                <div className={`fixed bottom-24 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-xl z-50 animate-fade-in flex items-center gap-2 ${type === 'error' ? 'bg-red-500 text-white' : 'bg-barong-navy text-barong-gold border border-barong-gold'}`}>
                    {type === 'success' ? <Icons.CheckCircle size={18} /> : <Icons.X size={18} />}
                    <span className="font-serif tracking-wide">{message}</span>
                </div>
            );
        };

        const HomeView = ({ userProfile, streak, userPoints, canCheckIn, handleCheckIn, setActiveTab, RESOURCES }) => {
            const [motivation, setMotivation] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const getWisdom = async () => {
                setLoading(true);
                const txt = await generateGeminiContent(`User: ${userProfile.name}, Streak: ${streak}. Motivational quote.`, "Recovery coach.");
                setMotivation(txt);
                setLoading(false);
            };
            return (
                <div className="space-y-6 p-6 pb-24 overflow-y-auto h-full">
                    <div className="glass-panel stitch-border rounded-3xl p-6 text-barong-cream bg-barong-navy relative overflow-hidden border-0 shadow-xl">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-barong-gold/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                        <h1 className="text-3xl font-bold relative z-10 flex items-center gap-2 font-serif">Kamusta, {userProfile.name} <Icons.Sparkles className="text-barong-gold" /></h1>
                        <p className="relative z-10 opacity-90 mt-2 font-light italic">"Ang pagbangon ay isang proseso."</p>
                        <div className="flex gap-3 mt-6 relative z-10">
                            <div className="bg-white/10 rounded-xl p-3 flex-1 border border-white/10"><div className="text-xs font-bold opacity-75 uppercase tracking-wider">Streak</div><div className="text-2xl font-bold font-serif">{streak} Araw</div></div>
                            <div className="bg-white/10 rounded-xl p-3 flex-1 border border-white/10"><div className="text-xs font-bold opacity-75 uppercase tracking-wider">Tokens</div><div className="text-2xl font-bold flex gap-1 font-serif">{userPoints} <Icons.Award className="text-barong-gold" /></div></div>
                        </div>
                        {/* UPDATED: Check-in button visibility fix */}
                        <Button onClick={handleCheckIn} disabled={!canCheckIn} className={`w-full mt-4 ${!canCheckIn ? 'opacity-80 bg-slate-300 text-slate-600 border-slate-400 cursor-not-allowed' : 'bg-barong-gold text-barong-navy border-none hover:bg-white'}`}>
                            {canCheckIn ? "Daily Check-in (+20 Pts)" : "Checked In Today"}
                        </Button>
                    </div>
                    <Card>
                        <div className="flex justify-between items-center mb-2"><h3 className="font-bold text-xl text-barong-navy dark:text-barong-cream flex gap-2 font-serif"><Icons.Lightbulb className="text-barong-gold" /> Daily Wisdom</h3><Button variant="outline" onClick={getWisdom} disabled={loading} className="py-1 text-xs">{loading ? "..." : "Get Insight"}</Button></div>
                        {motivation && <div className="bg-barong-beige/50 p-4 rounded-lg text-sm italic text-barong-navy border-l-4 border-barong-gold animate-fade-in"><MarkdownBlock content={motivation} /></div>}
                    </Card>
                    <Card>
                        <h3 className="font-bold text-xl text-barong-navy dark:text-barong-cream mb-3 font-serif">Resources</h3>
                        <div className="space-y-2">
                            {/* UPDATED: Expandable resources logic */}
                            {RESOURCES.map((r, i) => {
                                const [isOpen, setIsOpen] = React.useState(false);
                                return (
                                    <div key={i} className="rounded-xl bg-barong-beige/50 border border-barong-navy/5 overflow-hidden transition-all">
                                        <button onClick={() => setIsOpen(!isOpen)} className="w-full p-3 flex items-center justify-between text-left hover:bg-barong-gold/10">
                                            <div>
                                                <div className="font-bold text-barong-navy flex items-center gap-2">{r.title} {r.type === 'Emergency' && <Icons.ShieldCheck size={14} className="text-red-500" />}</div>
                                                <div className="text-xs text-slate-600">{r.desc}</div>
                                            </div>
                                            <div className={`transform transition-transform ${isOpen ? 'rotate-180' : ''}`}><Icons.Menu size={16} /></div>
                                        </button>
                                        {isOpen && (
                                            <div className="p-3 pt-0 space-y-2 bg-white/50">
                                                <div className="h-px bg-barong-navy/10 mb-2"></div>
                                                {r.details.map((d, j) => (
                                                    <div key={j} className="flex justify-between text-sm">
                                                        <span className="text-slate-500">{d.label}:</span>
                                                        {d.link ? (
                                                            <a href={d.link} className="font-bold text-barong-navy hover:text-barong-gold underline decoration-dotted">{d.value}</a>
                                                        ) : (
                                                            <span className="font-bold text-barong-navy">{d.value}</span>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </Card>
                    <div className="grid grid-cols-2 gap-4">
                        <button onClick={() => setActiveTab('chat')} className="glass-panel stitch-border p-6 rounded-2xl flex flex-col items-center text-center gap-3 hover:scale-[1.02] transition-transform group"><div className="w-14 h-14 bg-barong-navy rounded-full flex items-center justify-center text-barong-gold group-hover:bg-barong-gold group-hover:text-barong-navy transition-colors shadow-md"><Icons.MessageSquare /></div><span className="font-bold text-barong-navy dark:text-barong-cream">Kausapin si Gabay</span></button>
                        <button onClick={() => setActiveTab('jobs')} className="glass-panel stitch-border p-6 rounded-2xl flex flex-col items-center text-center gap-3 hover:scale-[1.02] transition-transform group"><div className="w-14 h-14 bg-barong-pink/50 rounded-full flex items-center justify-center text-barong-navy group-hover:bg-barong-pink group-hover:text-white transition-colors shadow-md"><Icons.Briefcase /></div><span className="font-bold text-barong-navy dark:text-barong-cream">Hanapbuhay</span></button>
                    </div>
                </div>
            );
        };

        const MessageItem = React.memo(({ msg }) => (
            <div className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'} animate-slide-up`}>
                <div className={`max-w-[85%] p-4 rounded-2xl text-sm shadow-sm ${msg.sender === 'user' ? 'bg-barong-navy text-barong-cream rounded-br-none border border-barong-navy' : 'bg-barong-cream dark:bg-slate-800 border border-barong-gold/30 text-barong-navy dark:text-slate-200 rounded-bl-none'}`}>
                    <MarkdownBlock content={msg.text} />
                </div>
            </div>
        ));

        const ChatView = React.memo(({ messages, isTyping, chatEndRef, inputText, setInputText, handleSend, clearChat }) => (
            <div className="flex flex-col h-full w-full relative overflow-hidden">
                {/* 1. Header (Fixed at Top) */}
                <div className="flex-shrink-0 p-4 bg-barong-cream/90 dark:bg-barong-dark/90 backdrop-blur-md border-b border-barong-gold/20 z-20 flex items-center justify-between shadow-sm">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-barong-navy rounded-full flex items-center justify-center text-barong-gold shadow-md border border-barong-gold"><Icons.ShieldCheck /></div>
                        <div><h3 className="font-bold text-barong-navy dark:text-barong-cream font-serif">Gabay</h3><p className="text-xs text-barong-blue dark:text-barong-beige font-semibold">AI Psychologist</p></div>
                    </div>
                    <button onClick={clearChat} className="text-xs text-barong-navy/60 hover:text-red-500 transition-colors font-bold uppercase tracking-wider">Clear</button>
                </div>

                {/* 2. Messages (Scrollable Middle Area) */}
                <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-transparent z-0 scrollbar-hide pb-20">
                    {messages.map((msg) => <MessageItem key={msg.id} msg={msg} />)}
                    {isTyping && <div className="flex justify-start"><div className="bg-barong-cream dark:bg-slate-800 p-3 rounded-2xl rounded-bl-none shadow-sm border border-barong-gold/30"><div className="flex gap-1"><div className="w-2 h-2 bg-barong-gold rounded-full animate-bounce"></div><div className="w-2 h-2 bg-barong-gold rounded-full animate-bounce delay-75"></div><div className="w-2 h-2 bg-barong-gold rounded-full animate-bounce delay-150"></div></div></div></div>}
                    <div ref={chatEndRef} />
                </div>

                {/* 3. Input Area (Fixed at Bottom of Chat Stack) */}
                <div className="absolute bottom-0 left-0 w-full p-3 bg-barong-cream/90 dark:bg-barong-dark/90 backdrop-blur-md border-t border-barong-gold/20 z-20">
                    <form onSubmit={(e) => { e.preventDefault(); handleSend(); }} className="flex gap-2 items-end">
                        <textarea rows={1} value={inputText} onChange={(e) => setInputText(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } }} placeholder="Type here..." className="flex-1 bg-barong-beige/50 dark:bg-slate-800 border border-barong-navy/10 rounded-2xl px-4 py-3 text-base focus:ring-2 focus:ring-barong-gold outline-none resize-none max-h-32 text-barong-navy placeholder-barong-navy/40" />
                        <button type="submit" disabled={isTyping} className="w-11 h-11 bg-barong-navy text-barong-gold border border-barong-gold rounded-full flex items-center justify-center shadow hover:scale-105 active:scale-95 transition-transform flex-shrink-0 disabled:opacity-50"><Icons.Send size={18} /></button>
                    </form>
                </div>
            </div>
        ));

        const JobsView = ({ JOB_LISTINGS, appliedJobs, handleJobApply, showToast }) => {
            const [input, setInput] = React.useState("");
            const [output, setOutput] = React.useState("");
            const [loading, setLoading] = React.useState(false);

            const generateResume = async () => {
                if (!input.trim()) return;
                setLoading(true);
                const txt = await generateGeminiContent(`Make resume bullets for: ${input}`, "Resume writer.");
                setOutput(txt);
                setLoading(false);
                showToast("Resume polished!", "success");
            }

            const downloadResume = () => {
                const element = document.createElement("a");
                const file = new Blob([output], { type: 'text/plain' });
                element.href = URL.createObjectURL(file);
                element.download = "Gabay_Resume.txt";
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
                showToast("Resume downloaded", "success");
            }

            return (
                <div className="space-y-5 p-6 pb-24 overflow-y-auto h-full">
                    <div className="bg-barong-beige/30 dark:bg-indigo-900/20 rounded-2xl p-5 border border-barong-gold/30 dark:border-indigo-800 stitch-border">
                        <h3 className="font-bold text-barong-navy dark:text-indigo-100 mb-2 flex gap-2 font-serif"><Icons.PenTool /> AI Resume Builder</h3>
                        <textarea value={input} onChange={(e) => setInput(e.target.value)} placeholder="Describe your work experience..." className="w-full p-3 rounded-xl bg-barong-cream/70 dark:bg-slate-800/70 text-base border border-barong-navy/10 outline-none mb-3 h-20 resize-none focus:border-barong-gold" />
                        <div className="flex gap-2">
                            <Button onClick={generateResume} disabled={loading || !input} className="flex-1 py-2 text-sm bg-barong-navy text-barong-gold">{loading ? "..." : "Polish with AI"}</Button>
                            {output && <Button onClick={downloadResume} variant="outline" className="py-2 px-3"><Icons.BookOpen size={16} /></Button>}
                        </div>
                        {output && <div className="mt-3 p-3 bg-white dark:bg-slate-800 rounded-xl text-sm whitespace-pre-wrap border border-barong-navy/10"><MarkdownBlock content={output} /></div>}
                    </div>
                    {JOB_LISTINGS.map(job => (
                        <Card key={job.id}>
                            <div className="flex justify-between mb-2"><h3 className="font-bold dark:text-white font-serif text-lg">{job.title}</h3><span className="bg-barong-gold/20 text-barong-navy text-xs px-2 py-1 rounded-lg border border-barong-gold/30">{job.type}</span></div>
                            <div className="text-xs text-slate-500 mb-4 flex gap-3"><span><Icons.MapPin size={12} /> {job.location}</span><span><Icons.BookOpen size={12} /> {job.duration}</span></div>
                            <Button variant={appliedJobs.includes(job.id) ? "secondary" : "primary"} onClick={() => !appliedJobs.includes(job.id) && handleJobApply(job.id)} className="w-full py-2 text-sm">{appliedJobs.includes(job.id) ? "Applied" : "Apply Now"}</Button>
                        </Card>
                    ))}
                </div>
            );
        };

        const RewardsView = ({ userPoints, inventory, handleRedeem }) => {
            const REWARDS = [
                { id: 'theme_premium', name: "Premium Profile Theme", cost: 500, icon: Icons.Sparkles, desc: "Unlocks a gold border and special background for your profile." },
                { id: 'coaching_session', name: "Career Coaching Session", cost: 300, icon: Icons.User, desc: "One-on-one simulation with a career expert." },
                { id: 'resume_pack', name: "Pro Resume Templates", cost: 150, icon: Icons.BookOpen, desc: "Unlock 3 professional resume formats." }
            ];

            return (
                <div className="space-y-6 p-6 pb-24 overflow-y-auto h-full">
                    <div className="bg-barong-navy text-barong-gold p-6 rounded-2xl shadow-lg flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold font-serif">Rewards Shop</h2>
                            <p className="text-barong-cream/80 text-sm">Spend your hard-earned tokens.</p>
                        </div>
                        <div className="text-right">
                            <div className="text-3xl font-bold">{userPoints}</div>
                            <div className="text-xs uppercase tracking-wider opacity-75">Available Points</div>
                        </div>
                    </div>

                    <div className="grid gap-4">
                        {REWARDS.map(reward => {
                            const isOwned = inventory.includes(reward.id);
                            const canAfford = userPoints >= reward.cost;
                            return (
                                <Card key={reward.id} className="flex items-center gap-4 relative overflow-hidden">
                                    <div className={`w-16 h-16 rounded-full flex items-center justify-center text-2xl ${isOwned ? 'bg-green-100 text-green-600' : 'bg-barong-gold/20 text-barong-navy'}`}>
                                        <reward.icon />
                                    </div>
                                    <div className="flex-1">
                                        <h3 className="font-bold text-barong-navy dark:text-barong-cream">{reward.name}</h3>
                                        <p className="text-xs text-slate-500 mb-2">{reward.desc}</p>
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold text-barong-gold">{reward.cost} Pts</span>
                                            {isOwned && <span className="text-xs text-green-600 font-bold bg-green-100 px-2 py-0.5 rounded-full">Owned</span>}
                                        </div>
                                    </div>
                                    <Button 
                                        onClick={() => handleRedeem(reward)} 
                                        disabled={isOwned || !canAfford} 
                                        variant={isOwned ? "outline" : "primary"}
                                        className={`text-xs px-3 ${isOwned ? 'opacity-50' : ''}`}
                                    >
                                        {isOwned ? "Redeemed" : "Redeem"}
                                    </Button>
                                </Card>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const MapView = () => {
            const mapContainerRef = React.useRef(null);
            const [userLocation, setUserLocation] = React.useState(null);
            const [mapInstance, setMapInstance] = React.useState(null);

            // Sample Data
            const RESOURCES_LOCATIONS = [
                { id: 1, name: "DREAM Rehab Center", lat: 14.6091, lng: 121.0223, type: "rehab", desc: "Accredited Rehabilitation" },
                { id: 2, name: "Metro Skills Hub", lat: 14.6507, lng: 121.0271, type: "training", desc: "Free Vocational Training" },
                { id: 3, name: "Hope General Hospital", lat: 14.5995, lng: 120.9842, type: "rehab", desc: "Medical Detox Unit" },
                { id: 4, name: "Community Center", lat: 14.6200, lng: 121.0500, type: "training", desc: "Livelihood Programs" }
            ];

            React.useEffect(() => {
                // Initialize Map
                if (!mapInstance && mapContainerRef.current) {
                    const map = L.map(mapContainerRef.current).setView([14.6091, 121.0223], 12); // Default Manila
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(map);

                    // Add Resource Markers
                    RESOURCES_LOCATIONS.forEach(loc => {
                        const color = loc.type === 'rehab' ? 'red' : 'blue';
                        const markerHtml = `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`;
                        const icon = L.divIcon({ className: 'custom-marker', html: markerHtml });
                        
                        L.marker([loc.lat, loc.lng], { icon }).addTo(map)
                            .bindPopup(`<b>${loc.name}</b><br>${loc.desc}`);
                    });

                    setMapInstance(map);

                    // Get User Location
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                const { latitude, longitude } = pos.coords;
                                setUserLocation({ lat: latitude, lng: longitude });
                                map.setView([latitude, longitude], 14);
                                
                                const userIcon = L.divIcon({ 
                                    className: 'user-marker', 
                                    html: '<div style="background-color: #C5A028; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(197, 160, 40, 0.5);"></div>' 
                                });
                                L.marker([latitude, longitude], { icon: userIcon }).addTo(map).bindPopup("You are here").openPopup();
                            },
                            (err) => console.error("Location access denied"),
                            { enableHighAccuracy: true }
                        );
                    }

                    // Cleanup function to remove map instance
                    return () => {
                        map.remove();
                        setMapInstance(null);
                    };
                }
            }, []);

            return (
                <div className="h-full flex flex-col relative">
                    <div ref={mapContainerRef} className="flex-1 z-0" style={{ minHeight: '50%' }} />
                    <div className="bg-white dark:bg-slate-900 p-4 rounded-t-3xl -mt-6 relative z-10 shadow-[0_-4px_20px_rgba(0,0,0,0.1)] flex-1 overflow-y-auto pb-24">
                        <div className="w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mx-auto mb-4"></div>
                        <h3 className="font-bold text-xl text-barong-navy dark:text-barong-cream mb-4 flex items-center gap-2 font-serif"><Icons.Map className="text-barong-gold" /> Nearby Resources</h3>
                        <div className="space-y-3">
                            {RESOURCES_LOCATIONS.map(loc => (
                                <div key={loc.id} className="flex items-start gap-3 p-3 rounded-xl bg-barong-beige/50 dark:bg-slate-800 border border-barong-navy/5">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ${loc.type === 'rehab' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>
                                        {loc.type === 'rehab' ? <Icons.ShieldCheck size={18} /> : <Icons.BookOpen size={18} />}
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-barong-navy dark:text-barong-cream">{loc.name}</h4>
                                        <p className="text-xs text-slate-500">{loc.desc}</p>
                                        <button onClick={() => mapInstance?.flyTo([loc.lat, loc.lng], 16)} className="text-xs text-barong-gold font-bold mt-1 hover:underline">View on Map</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const LoginView = ({ userProfile, setUserProfile, handleLogin }) => (
            <div className="flex flex-col items-center justify-center h-full p-8 text-center relative z-10">
                <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
                    <div className="absolute top-10 left-10 w-32 h-32 bg-barong-gold/20 rounded-full blur-3xl animate-blob"></div>
                    <div className="absolute bottom-10 right-10 w-40 h-40 bg-barong-pink/20 rounded-full blur-3xl animate-blob animation-delay-2000"></div>
                </div>
                <div className="w-24 h-24 bg-barong-navy rounded-2xl flex items-center justify-center mb-6 shadow-xl border-2 border-barong-gold rotate-3 hover:rotate-0 transition-transform duration-500"><Icons.Sun size={48} className="text-barong-gold animate-pulse-slow" /></div>
                <h1 className="text-4xl font-bold text-barong-navy mb-2 font-serif tracking-tight">Gabay</h1>
                <p className="text-slate-500 mb-8 font-light">Your AI Companion for Recovery</p>
                <div className="w-full max-w-xs space-y-4 backdrop-blur-sm bg-white/30 p-6 rounded-2xl border border-white/50 shadow-sm">
                    <input type="text" placeholder="Your Name" value={userProfile.name} onChange={e => setUserProfile({ ...userProfile, name: e.target.value })} className="w-full p-4 rounded-xl bg-barong-cream border border-barong-navy/20 outline-none focus:border-barong-gold focus:ring-2 focus:ring-barong-gold/20 transition-all text-barong-navy placeholder-barong-navy/40 text-base" />
                    <input type="number" placeholder="Age" value={userProfile.age} onChange={e => setUserProfile({ ...userProfile, age: e.target.value })} className="w-full p-4 rounded-xl bg-barong-cream border border-barong-navy/20 outline-none focus:border-barong-gold focus:ring-2 focus:ring-barong-gold/20 transition-all text-barong-navy placeholder-barong-navy/40 text-base" />
                    <div className="flex gap-2">
                        {['Male', 'Female'].map(s => (
                            <button key={s} onClick={() => setUserProfile({ ...userProfile, sex: s })} className={`flex-1 p-3 rounded-xl border transition-all font-medium ${userProfile.sex === s ? 'bg-barong-navy text-barong-gold border-barong-navy shadow-md' : 'bg-transparent border-barong-navy/20 text-slate-500 hover:bg-barong-navy/5'}`}>{s}</button>
                        ))}
                    </div>
                    <Button onClick={handleLogin} disabled={!userProfile.name || !userProfile.age || !userProfile.sex} className="w-full py-4 text-lg font-bold shadow-lg mt-2 bg-barong-navy text-barong-gold border border-barong-gold hover:scale-[1.02] active:scale-[0.98] transition-all">Begin Journey</Button>
                </div>
            </div>
        );

        // --- MAIN APP ---
        function App() {
            // REFACTORED: Using useLocalStorage hook with v2 keys to reset state
            const [isLoggedIn, setIsLoggedIn] = useLocalStorage('gabay_isLoggedIn_v2', false);
            const [isDarkMode, setIsDarkMode] = useLocalStorage('gabay_isDarkMode_v2', false);
            const [userProfile, setUserProfile] = useLocalStorage('gabay_userProfile_v2', { name: '', age: '', sex: '' });
            const [userPoints, setUserPoints] = useLocalStorage('gabay_userPoints_v2', 0); // Reset to 0
            const [streak, setStreak] = useLocalStorage('gabay_streak_v2', 0); // Reset to 0
            const [appliedJobs, setAppliedJobs] = useLocalStorage('gabay_appliedJobs_v2', []);
            const [messages, setMessages] = useLocalStorage('gabay_messages_v2', []);
            const [inventory, setInventory] = useLocalStorage('gabay_inventory_v2', []);
            const [lastCheckInDate, setLastCheckInDate] = useLocalStorage('gabay_lastCheckInDate_v2', '');

            const [activeTab, setActiveTab] = React.useState('home');
            const [isSidebarOpen, setIsSidebarOpen] = React.useState(false);
            const [inputText, setInputText] = React.useState('');
            const [isTyping, setIsTyping] = React.useState(false);
            const [toast, setToast] = React.useState(null);
            const [showCrisisModal, setShowCrisisModal] = React.useState(false);

            const chatEndRef = React.useRef(null);

            // Derived state for check-in
            const today = new Date().toISOString().split('T')[0];
            const canCheckIn = lastCheckInDate !== today;

            React.useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, isTyping]);

            // RED FLAG PROTOCOL - Moved outside or memoized
            const detectCrisis = React.useCallback((text) => {
                const crisisKeywords = [/suicide/i, /kill myself/i, /want to die/i, /overdose/i, /hurt myself/i, /end it all/i];
                return crisisKeywords.some(regex => regex.test(text));
            }, []);

            // Initial Greeting if empty
            React.useEffect(() => {
                if (isLoggedIn && messages.length === 0) {
                    setMessages([{ id: 1, sender: 'ai', text: `Kamusta ${userProfile.name}? I'm Gabay. How are you feeling today?` }]);
                }
            }, [isLoggedIn, messages.length, userProfile.name, setMessages]);

            // Dark Mode Effect
            React.useEffect(() => {
                if (isDarkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [isDarkMode]);

            const showToast = (msg, type = 'success') => setToast({ msg, type });

            const handleLogin = React.useCallback(() => {
                if (userProfile.name && userProfile.age) {
                    setIsLoggedIn(true);
                    showToast(`Welcome, ${userProfile.name}!`);
                }
            }, [userProfile.name, userProfile.age, setIsLoggedIn]);

            const handleLogout = React.useCallback(() => {
                if (confirm("Are you sure you want to log out?")) {
                    setIsLoggedIn(false);
                    setActiveTab('home');
                    showToast("Logged out successfully");
                }
            }, [setIsLoggedIn]);

            const handleCheckIn = React.useCallback(() => {
                if (!canCheckIn) return;

                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];

                if (lastCheckInDate === yesterdayStr) {
                    setStreak(s => s + 1);
                } else {
                    setStreak(1); // Reset if missed a day or first time
                }

                setLastCheckInDate(today);
                setUserPoints(p => p + 20);
                showToast("Daily Check-in Complete! +20 Pts");
            }, [canCheckIn, lastCheckInDate, today, setStreak, setLastCheckInDate, setUserPoints]);

            const handleSend = React.useCallback(async () => {
                if (!inputText.trim()) return;
                
                const userMsg = { id: Date.now(), sender: 'user', text: inputText };
                setMessages(prev => [...prev, userMsg]);
                setInputText('');

                // RED FLAG CHECK
                if (detectCrisis(userMsg.text)) {
                    setShowCrisisModal(true);
                    const crisisMsg = { 
                        id: Date.now() + 1, 
                        sender: 'ai', 
                        text: "**I'm concerned about you.** \n\nIt sounds like you're going through a very difficult time. Please know that you are not alone and there is help available.\n\n**Emergency Hotlines:**\n*   **NCMH Crisis Hotline:** 1553 (Luzon-wide landline toll-free)\n*   **Globe/TM:** 0966-351-4518\n*   **Smart/Sun/TNT:** 0908-639-2672\n\nPlease reach out to them immediately." 
                    };
                    setMessages(prev => [...prev, crisisMsg]);
                    return; // Stop AI generation
                }

                setIsTyping(true);
                try {
                    const aiText = await callChatAI(userMsg.text, messages, userProfile, streak);
                    setMessages(prev => [...prev, { id: Date.now() + 1, sender: 'ai', text: aiText }]);
                } catch (e) {
                    setMessages(prev => [...prev, { id: Date.now() + 1, sender: 'ai', text: "Connection error." }]);
                    showToast("Failed to connect to AI", "error");
                }
                setIsTyping(false);
            }, [inputText, detectCrisis, messages, userProfile, streak, setMessages]);

            const clearChat = React.useCallback(() => {
                if (confirm("Clear chat history?")) {
                    // UPDATED: Warmer greeting after clear
                    setMessages([{ id: Date.now(), sender: 'ai', text: "Kamusta ka? Nandito lang ako para makinig." }]);
                    showToast("Chat history cleared");
                }
            }, [setMessages]);

            const handleJobApply = React.useCallback((jobId) => {
                setAppliedJobs(prev => [...prev, jobId]);
                showToast("Application Sent!", "success");
            }, [setAppliedJobs]);

            const handleRedeem = React.useCallback((reward) => {
                if (userPoints >= reward.cost) {
                    setUserPoints(prev => prev - reward.cost);
                    setInventory(prev => [...prev, reward.id]);
                    showToast(`Redeemed: ${reward.name}!`);
                } else {
                    showToast("Not enough points", "error");
                }
            }, [userPoints, setUserPoints, setInventory]);

            if (!isLoggedIn) return <LoginView userProfile={userProfile} setUserProfile={setUserProfile} handleLogin={handleLogin} />;

            return (
                <div className="flex flex-col h-[100dvh] bg-barong-beige dark:bg-slate-900 text-barong-navy dark:text-slate-200 font-sans overflow-hidden relative transition-colors duration-300">
                    {/* Background Elements */}
                    <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
                        <div className="absolute -top-20 -right-20 w-64 h-64 bg-barong-gold/10 rounded-full blur-3xl animate-blob"></div>
                        <div className="absolute top-40 -left-20 w-72 h-72 bg-barong-pink/10 rounded-full blur-3xl animate-blob animation-delay-2000"></div>
                    </div>

                    {/* Top Navigation */}
                    <nav className="flex-shrink-0 p-4 flex justify-between items-center bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-barong-navy/5 z-30 relative">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-barong-navy rounded-lg flex items-center justify-center text-barong-gold"><Icons.Sun size={18} /></div>
                            <span className="font-bold text-xl font-serif tracking-tight">Gabay</span>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors">{isDarkMode ? <Icons.Sun size={20} /> : <Icons.Moon size={20} />}</button>
                            <button onClick={handleLogout} className="p-2 rounded-full hover:bg-red-50 text-slate-400 hover:text-red-500 transition-colors"><Icons.LogOut size={20} /></button>
                        </div>
                    </nav>

                    {/* Main Content Area */}
                    <main className="flex-1 overflow-hidden relative z-10">
                        {activeTab === 'home' && <HomeView userProfile={userProfile} streak={streak} userPoints={userPoints} canCheckIn={canCheckIn} handleCheckIn={handleCheckIn} setActiveTab={setActiveTab} RESOURCES={RESOURCES} />}
                        {activeTab === 'chat' && <ChatView messages={messages} isTyping={isTyping} chatEndRef={chatEndRef} inputText={inputText} setInputText={setInputText} handleSend={handleSend} clearChat={clearChat} />}
                        {activeTab === 'jobs' && <JobsView JOB_LISTINGS={JOB_LISTINGS} appliedJobs={appliedJobs} handleJobApply={handleJobApply} showToast={showToast} />}
                        {activeTab === 'rewards' && <RewardsView userPoints={userPoints} inventory={inventory} handleRedeem={handleRedeem} />}
                        {activeTab === 'map' && <MapView />}
                    </main>

                    {/* Bottom Navigation */}
                    <div className="flex-shrink-0 bg-white dark:bg-slate-900 border-t border-barong-navy/5 pb-safe z-30 relative">
                        <div className="flex justify-around p-2">
                            {[
                                { id: 'home', icon: Icons.Heart, label: 'Home' },
                                { id: 'chat', icon: Icons.MessageSquare, label: 'Chat' },
                                { id: 'map', icon: Icons.Map, label: 'Map' },
                                { id: 'jobs', icon: Icons.Briefcase, label: 'Jobs' },
                                { id: 'rewards', icon: Icons.Gift, label: 'Rewards' }
                            ].map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center p-2 rounded-xl transition-all w-16 ${activeTab === tab.id ? 'text-barong-navy dark:text-barong-gold bg-barong-gold/10 scale-105' : 'text-slate-400 hover:text-barong-navy dark:hover:text-slate-200'}`}>
                                    <tab.icon size={24} strokeWidth={activeTab === tab.id ? 2.5 : 2} />
                                    <span className="text-[10px] font-bold mt-1">{tab.label}</span>
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Toast Notification */}
                    {toast && <Toast message={toast.msg} type={toast.type} onClose={() => setToast(null)} />}
                    
                    {/* Crisis Modal */}
                    {showCrisisModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-6 animate-fade-in">
                            <div className="bg-white dark:bg-slate-800 rounded-3xl p-6 max-w-sm w-full border-l-8 border-red-500 shadow-2xl relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-4 opacity-10"><Icons.AlertTriangle size={100} className="text-red-500" /></div>
                                <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center text-red-600 mb-4 mx-auto"><Icons.AlertTriangle size={32} /></div>
                                <h2 className="text-2xl font-bold text-center text-red-600 mb-2 font-serif">Help is available</h2>
                                <p className="text-center text-slate-600 dark:text-slate-300 mb-6">You don't have to go through this alone. Professional support is just a call away.</p>
                                <div className="space-y-3">
                                    <a href="tel:1553" className="flex items-center gap-4 p-4 bg-red-50 rounded-xl border border-red-100 hover:bg-red-100 transition-colors group">
                                        <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-red-500 shadow-sm"><Icons.Phone size={20} /></div>
                                        <div><div className="font-bold text-red-800">Call 1553</div><div className="text-xs text-red-600">NCMH Crisis Hotline</div></div>
                                    </a>
                                    <Button onClick={() => setShowCrisisModal(false)} variant="outline" className="w-full border-slate-200 text-slate-500">I'm okay now</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
